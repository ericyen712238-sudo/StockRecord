<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç¾è‚¡æŠ•è³‡è¨˜å¸³æœ¬ (å¤šå¸³æˆ¶ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff; 
            border-bottom: 1px solid #e2e8f0;
        }
        .autocomplete-items div:hover {
            background-color: #f8fafc; 
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20 md:pb-0">

    <!-- å°èˆªåˆ— -->
    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-chart-line text-red-400 text-xl"></i>
                    <h1 class="text-xl font-bold tracking-wider">å°ç¾è‚¡è¨˜å¸³æœ¬</h1>
                </div>
                <!-- æ‰‹æ©Ÿç‰ˆå³å´æŒ‰éˆ•ç¾¤ (å¦‚æœéœ€è¦å¯æ“´å……) -->
            </div>

            <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                <!-- å¸³æˆ¶åˆ‡æ›å™¨ -->
                <div class="relative group">
                    <button onclick="toggleAccountMenu()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg border border-slate-700 transition-colors text-sm">
                        <i class="fa-solid fa-wallet text-blue-400"></i>
                        <span id="currentAccountLabel" class="font-medium">å…¨éƒ¨å¸³æˆ¶</span>
                        <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                    </button>
                    <!-- ä¸‹æ‹‰é¸å–® -->
                    <div id="accountMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-50 text-slate-800">
                        <div id="accountListContainer" class="max-h-60 overflow-y-auto">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <div class="border-t border-slate-100 p-2 bg-slate-50">
                            <button onclick="openAccountManager()" class="w-full text-left px-3 py-2 text-sm text-blue-600 hover:bg-slate-200 rounded-lg flex items-center gap-2 font-medium">
                                <i class="fa-solid fa-cog"></i> ç®¡ç†å¸³æˆ¶
                            </button>
                        </div>
                    </div>
                </div>

                <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full flex items-center gap-2 text-sm font-medium transition-colors shadow-md transform active:scale-95 whitespace-nowrap">
                    <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">æ–°å¢äº¤æ˜“</span>
                    <span class="sm:hidden">æ–°å¢</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 space-y-6">
        
        <!-- åŒ¯ç‡è¨­å®š (ç°¡æ˜“ç‰ˆ) -->
        <div class="flex justify-between items-center text-xs text-slate-500">
             <div class="flex items-center gap-2">
                <span id="viewingHint" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-md font-bold hidden">ç›®å‰æª¢è¦–ï¼šå…¨éƒ¨å¸³æˆ¶</span>
            </div>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-earth-americas"></i>
                <span>USD/TWD åŒ¯ç‡: </span>
                <input type="number" id="exchangeRate" value="31.5" class="w-16 bg-white border border-slate-300 rounded px-1 text-center" onchange="updateDashboard()">
            </div>
        </div>

        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="summaryCards">
            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- æ¨™ç±¤åˆ‡æ› -->
        <div class="flex gap-4 border-b border-slate-200">
            <button onclick="switchTab('portfolio')" id="tab-portfolio" class="pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-blue-600 text-blue-600">
                <i class="fa-solid fa-chart-pie mr-1"></i> åº«å­˜æŒè‚¡
            </button>
            <button onclick="switchTab('transactions')" id="tab-transactions" class="pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-700">
                <i class="fa-solid fa-list-ul mr-1"></i> äº¤æ˜“æ˜ç´°
            </button>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div id="contentArea" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden min-h-[300px]">
            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
        </div>
    </div>

    <!-- æ–°å¢äº¤æ˜“ Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 fade-in flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b border-slate-100 bg-slate-50 shrink-0">
                <h2 class="text-lg font-bold text-slate-800">æ–°å¢äº¤æ˜“</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            
            <form id="transactionForm" onsubmit="handleFormSubmit(event)" class="p-6 space-y-4 overflow-y-auto">
                <!-- å¸³æˆ¶é¸æ“‡ -->
                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ­¸å±¬å¸³æˆ¶</label>
                    <select id="modalAccountSelect" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white font-medium text-slate-700">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>

                <!-- æ—¥æœŸèˆ‡é¡åˆ¥ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">äº¤æ˜“æ—¥æœŸ</label>
                        <input type="date" id="date" required class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">äº¤æ˜“é¡åˆ¥</label>
                        <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                            <button type="button" onclick="setTransactionType('buy')" id="btn-buy" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all bg-red-500 text-white shadow-sm">è²·å…¥</button>
                            <button type="button" onclick="setTransactionType('sell')" id="btn-sell" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-slate-500 hover:bg-slate-200">è³£å‡º</button>
                        </div>
                        <input type="hidden" id="type" value="buy">
                    </div>
                </div>

                <!-- è‚¡ç¥¨ä»£è™Ÿ (è‡ªå‹•å®Œæˆ) -->
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 mb-1">è‚¡ç¥¨ä»£è™Ÿ/åç¨± (æœå°‹)</label>
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                        <input type="text" id="code" required placeholder="è¼¸å…¥ 2330 æˆ– AAPL..." autocomplete="off"
                            class="w-full pl-9 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono"
                            oninput="handleStockInput(this.value)">
                    </div>
                    <div id="autocomplete-list" class="autocomplete-items hidden"></div>
                </div>

                <!-- è‚¡ç¥¨è³‡è¨Šé è¦½ -->
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è‚¡ç¥¨åç¨±</label>
                        <input type="text" id="name" placeholder="å°ç©é›»" class="w-full border border-slate-300 bg-slate-50 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 mb-1">å¸‚å ´å¹£åˆ¥</label>
                         <select id="currency" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                             <option value="TWD">TWD (å°å¹£)</option>
                             <option value="USD">USD (ç¾å…ƒ)</option>
                         </select>
                    </div>
                </div>

                <!-- åƒ¹æ ¼èˆ‡æ•¸é‡ -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æˆäº¤å–®åƒ¹</label>
                        <input type="number" id="price" step="0.01" required placeholder="0.00" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">è‚¡æ•¸</label>
                        <input type="number" id="qty" required placeholder="1000" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                    </div>
                </div>

                <!-- æ‰‹çºŒè²» -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æ‰‹çºŒè²» (å«ç¨…)</label>
                    <div class="relative">
                        <i class="fa-solid fa-coins absolute left-3 top-3 text-slate-400"></i>
                        <input type="number" id="fee" step="0.01" value="0" class="w-full pl-9 border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all flex justify-center items-center gap-2 transform active:scale-[0.98]">
                        <i class="fa-solid fa-save"></i> å„²å­˜äº¤æ˜“
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¸³æˆ¶ç®¡ç† Modal -->
    <div id="accountManagerModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden fade-in">
            <div class="flex justify-between items-center p-5 border-b border-slate-100 bg-slate-50">
                <h2 class="text-lg font-bold text-slate-800">ç®¡ç†å¸³æˆ¶</h2>
                <button onclick="closeAccountManager()" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="p-5">
                <!-- æ–°å¢å¸³æˆ¶ -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newAccountName" placeholder="è¼¸å…¥æ–°å¸³æˆ¶åç¨±..." class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <button onclick="addNewAccount()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">
                        æ–°å¢
                    </button>
                </div>

                <!-- å¸³æˆ¶åˆ—è¡¨ -->
                <div class="space-y-2 max-h-60 overflow-y-auto" id="manageAccountList">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // --- 1. è‚¡ç¥¨è³‡æ–™åº« (æ¨¡æ“¬ Database) ---
        const STOCK_DB = [
            // å°è‚¡
            { code: '2330', name: 'å°ç©é›»', type: 'TW', price: 580 },
            { code: '2317', name: 'é´»æµ·', type: 'TW', price: 102 },
            { code: '2454', name: 'è¯ç™¼ç§‘', type: 'TW', price: 950 },
            { code: '2603', name: 'é•·æ¦®', type: 'TW', price: 155 },
            { code: '2303', name: 'è¯é›»', type: 'TW', price: 50.5 },
            { code: '0050', name: 'å…ƒå¤§å°ç£50', type: 'TW', price: 135 },
            { code: '0056', name: 'å…ƒå¤§é«˜è‚¡æ¯', type: 'TW', price: 35 },
            { code: '00878', name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', type: 'TW', price: 21.5 },
            { code: '00929', name: 'å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯', type: 'TW', price: 18.2 },
            // ç¾è‚¡
            { code: 'AAPL', name: 'Apple Inc.', type: 'US', price: 195.5 },
            { code: 'MSFT', name: 'Microsoft', type: 'US', price: 375.2 },
            { code: 'TSLA', name: 'Tesla', type: 'US', price: 240.1 },
            { code: 'NVDA', name: 'NVIDIA', type: 'US', price: 485.6 },
            { code: 'GOOGL', name: 'Alphabet A', type: 'US', price: 138.2 },
            { code: 'AMZN', name: 'Amazon', type: 'US', price: 145.8 },
            { code: 'AMD', name: 'AMD', type: 'US', price: 120.5 },
            { code: 'META', name: 'Meta', type: 'US', price: 330.4 },
            { code: 'NFLX', name: 'Netflix', type: 'US', price: 475.2 },
            { code: 'VOO', name: 'Vanguard S&P 500', type: 'US', price: 435.1 },
            { code: 'QQQ', name: 'Invesco QQQ', type: 'US', price: 390.5 }
        ];

        // --- 2. ç‹€æ…‹ç®¡ç† ---
        const DEFAULT_ACC_ID = 'main_acc';
        
        let state = {
            activeTab: 'portfolio',
            transactions: JSON.parse(localStorage.getItem('stock_transactions')) || [],
            currentPrices: JSON.parse(localStorage.getItem('stock_prices')) || {},
            exchangeRate: 31.5,
            accounts: JSON.parse(localStorage.getItem('stock_accounts')) || [{id: DEFAULT_ACC_ID, name: 'ä¸»è¦å¸³æˆ¶'}],
            activeAccountId: 'all' // 'all' or specific account id
        };

        // åˆå§‹åŒ–èˆ‡é·ç§»é‚è¼¯
        window.onload = () => {
            // è³‡æ–™é·ç§»ï¼šå¦‚æœèˆŠè³‡æ–™æ²’æœ‰ accountIdï¼Œåˆ†é…çµ¦é è¨­å¸³æˆ¶
            let migrated = false;
            state.transactions.forEach(t => {
                if (!t.accountId) {
                    t.accountId = DEFAULT_ACC_ID;
                    migrated = true;
                }
            });
            if (migrated) {
                saveData();
            }

            // è¨­å®šä»Šæ—¥æ—¥æœŸ
            document.getElementById('date').valueAsDate = new Date();
            
            // å¦‚æœæ²’æœ‰åƒ¹æ ¼ç´€éŒ„ï¼Œå¾ DB åˆå§‹åŒ–éƒ¨åˆ†
            if (Object.keys(state.currentPrices).length === 0) {
                STOCK_DB.forEach(stock => {
                    state.currentPrices[stock.code] = stock.price;
                });
            }

            updateAccountMenuUI();
            renderAll();
        };

        function saveData() {
            localStorage.setItem('stock_transactions', JSON.stringify(state.transactions));
            localStorage.setItem('stock_accounts', JSON.stringify(state.accounts));
            localStorage.setItem('stock_prices', JSON.stringify(state.currentPrices));
        }

        // --- 3. æ ¸å¿ƒé‚è¼¯ (è¨ˆç®—) ---
        function calculatePortfolio() {
            const holdings = {};
            let totalRealizedPnL_TWD = 0;

            // æ ¹æ“š activeAccountId éæ¿¾äº¤æ˜“
            const filteredTrans = state.activeAccountId === 'all' 
                ? state.transactions 
                : state.transactions.filter(t => t.accountId === state.activeAccountId);

            const sortedTrans = [...filteredTrans].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTrans.forEach(t => {
                // å¦‚æœæ˜¯ All è¦–åœ–ï¼Œkey åŠ ä¸Š accountId é¿å…ä¸åŒå¸³æˆ¶åŒè‚¡ç¥¨æ··æ·†ï¼Ÿ
                // æ±ºå®šï¼šAll è¦–åœ–åˆä½µè¨ˆç®—åŒä»£è™Ÿè‚¡ç¥¨ï¼Œæ–¹ä¾¿çœ‹ç¸½æ›éšªã€‚
                const key = t.code; 
                
                if (!holdings[key]) {
                    holdings[key] = { 
                        code: t.code, 
                        name: t.name, 
                        currency: t.currency || 'TWD',
                        qty: 0, 
                        totalCost: 0, 
                        avgCost: 0,
                        realizedPnL: 0 
                    };
                }
                
                const stock = holdings[key];
                const fee = Number(t.fee);
                const qty = Number(t.qty);
                const price = Number(t.price);

                if (t.type === 'buy') {
                    stock.qty += qty;
                    stock.totalCost += (price * qty) + fee;
                    stock.avgCost = stock.qty > 0 ? stock.totalCost / stock.qty : 0;
                } else {
                    // Sell
                    const costBasis = stock.avgCost * qty;
                    const revenue = (price * qty) - fee;
                    const tradePnL = revenue - costBasis;
                    
                    stock.realizedPnL += tradePnL;
                    // å°‡å·²å¯¦ç¾æç›Šæ›ç®—å›å°å¹£åŠ ç¸½ (è‹¥æ˜¯ç¾è‚¡)
                    totalRealizedPnL_TWD += (stock.currency === 'USD' ? tradePnL * state.exchangeRate : tradePnL);

                    stock.qty -= qty;
                    stock.totalCost -= costBasis;
                    
                    if (stock.qty <= 0) {
                        stock.qty = 0; stock.totalCost = 0; stock.avgCost = 0;
                    }
                }
            });

            // è¨ˆç®—ç¾å€¼èˆ‡æœªå¯¦ç¾æç›Š
            const holdingList = Object.values(holdings).filter(h => h.qty > 0 || h.realizedPnL !== 0).map(h => {
                const currentPrice = state.currentPrices[h.code] || h.avgCost;
                const marketValue = h.qty * currentPrice;
                const unrealizedPnL = marketValue - h.totalCost;
                const returnRate = h.totalCost > 0 ? (unrealizedPnL / h.totalCost) * 100 : 0;

                return { ...h, currentPrice, marketValue, unrealizedPnL, returnRate };
            });

            // ç¸½è³‡ç”¢è¨ˆç®— (å…¨éƒ¨æ›ç®—å› TWD)
            let totalMarketValue_TWD = 0;
            let totalCost_TWD = 0;

            holdingList.filter(h => h.qty > 0).forEach(h => {
                const rate = h.currency === 'USD' ? state.exchangeRate : 1;
                totalMarketValue_TWD += h.marketValue * rate;
                totalCost_TWD += h.totalCost * rate;
            });

            const totalUnrealizedPnL_TWD = totalMarketValue_TWD - totalCost_TWD;

            return {
                holdings: holdingList.filter(h => h.qty > 0),
                summary: {
                    totalMarketValue_TWD,
                    totalCost_TWD,
                    totalUnrealizedPnL_TWD,
                    totalRealizedPnL_TWD
                }
            };
        }

        // --- 4. æ¸²æŸ“ UI ---
        function renderAll() {
            state.exchangeRate = Number(document.getElementById('exchangeRate').value) || 31.5;
            const data = calculatePortfolio();
            renderSummary(data.summary);
            
            // Update Hint
            const hint = document.getElementById('viewingHint');
            if (state.activeAccountId === 'all') {
                hint.innerText = `ç›®å‰æª¢è¦–ï¼šå…¨éƒ¨å¸³æˆ¶`;
                hint.className = "bg-slate-800 text-white px-2 py-0.5 rounded-md font-bold text-xs";
            } else {
                const acc = state.accounts.find(a => a.id === state.activeAccountId);
                hint.innerText = `ç›®å‰æª¢è¦–ï¼š${acc ? acc.name : 'æœªçŸ¥å¸³æˆ¶'}`;
                hint.className = "bg-blue-100 text-blue-800 px-2 py-0.5 rounded-md font-bold text-xs";
            }
            hint.classList.remove('hidden');

            if (state.activeTab === 'portfolio') {
                renderPortfolioTable(data.holdings);
            } else {
                renderTransactionsTable();
            }
        }

        function updateDashboard() {
            renderAll();
        }

        function renderSummary(summary) {
            const getColor = (val) => val > 0 ? 'text-red-500' : (val < 0 ? 'text-green-500' : 'text-slate-500');
            const format = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(val);
            
            const roi = summary.totalCost_TWD > 0 ? ((summary.totalUnrealizedPnL_TWD / summary.totalCost_TWD) * 100).toFixed(2) : '0.00';

            document.getElementById('summaryCards').innerHTML = `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-slate-500 text-sm font-medium mb-1">åº«å­˜ç¸½å¸‚å€¼ (TWD)</h3>
                    <p class="text-3xl font-bold text-slate-800">${format(summary.totalMarketValue_TWD)}</p>
                    <div class="text-xs text-slate-400 mt-2">å«ç¾è‚¡æ›ç®— (${state.exchangeRate})</div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-slate-500 text-sm font-medium mb-1">æœªå¯¦ç¾æç›Š (TWD)</h3>
                    <p class="text-3xl font-bold ${getColor(summary.totalUnrealizedPnL_TWD)}">
                        ${summary.totalUnrealizedPnL_TWD > 0 ? '+' : ''}${format(summary.totalUnrealizedPnL_TWD)}
                    </p>
                    <p class="text-sm mt-1 font-medium ${getColor(summary.totalUnrealizedPnL_TWD)}">${roi}% å ±é…¬ç‡</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-slate-500 text-sm font-medium mb-1">å·²å¯¦ç¾æç›Š (TWD)</h3>
                    <p class="text-3xl font-bold ${getColor(summary.totalRealizedPnL_TWD)}">
                        ${summary.totalRealizedPnL_TWD > 0 ? '+' : ''}${format(summary.totalRealizedPnL_TWD)}
                    </p>
                    <div class="text-xs text-slate-400 mt-2">æ­·å²ç²åˆ©ç¸½çµç®—</div>
                </div>
            `;
        }

        function renderPortfolioTable(holdings) {
            const container = document.getElementById('contentArea');
            if (holdings.length === 0) {
                container.innerHTML = `<div class="p-12 text-center text-slate-400 flex flex-col items-center">
                    <i class="fa-solid fa-chart-pie text-5xl mb-4 opacity-20"></i>
                    <p>æ­¤å¸³æˆ¶ç›®å‰æ²’æœ‰åº«å­˜æŒè‚¡ã€‚</p>
                </div>`;
                return;
            }

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-4 font-semibold sticky left-0 bg-slate-50 z-10">è‚¡ç¥¨</th>
                                <th class="p-4 font-semibold text-right">è‚¡æ•¸</th>
                                <th class="p-4 font-semibold text-right">å‡åƒ¹</th>
                                <th class="p-4 font-semibold text-right w-32">ç¾åƒ¹ (å¯æ”¹)</th>
                                <th class="p-4 font-semibold text-right">å¸‚å€¼</th>
                                <th class="p-4 font-semibold text-right">æç›Š</th>
                                <th class="p-4 font-semibold text-right">å ±é…¬ç‡</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
            `;

            holdings.forEach(h => {
                const currencySymbol = h.currency === 'USD' ? '$' : 'NT$';
                const pnlColor = h.unrealizedPnL > 0 ? 'text-red-500' : (h.unrealizedPnL < 0 ? 'text-green-500' : 'text-slate-500');
                const badgeColor = h.returnRate > 0 ? 'bg-red-50 text-red-600' : (h.returnRate < 0 ? 'bg-green-50 text-green-600' : 'bg-gray-50 text-gray-500');
                
                // æ ¼å¼åŒ–ï¼šç¾è‚¡ä¿ç•™2ä½å°æ•¸ï¼Œå°è‚¡æ•´æ•¸(å¸‚å€¼)
                const fmtMoney = (val) => new Intl.NumberFormat('en-US', { minimumFractionDigits: h.currency==='USD'?2:0, maximumFractionDigits: 2 }).format(val);

                html += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 sticky left-0 bg-white hover:bg-slate-50 border-r border-slate-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <div class="font-bold text-slate-800 flex items-center gap-2">
                                <span class="px-1.5 py-0.5 rounded text-[10px] ${h.currency==='USD'?'bg-blue-100 text-blue-700':'bg-slate-200 text-slate-600'}">${h.currency}</span>
                                ${h.name}
                            </div>
                            <div class="text-xs text-slate-400 mt-0.5">${h.code}</div>
                        </td>
                        <td class="p-4 text-right font-mono">${h.qty}</td>
                        <td class="p-4 text-right font-mono text-slate-500">${fmtMoney(h.avgCost)}</td>
                        <td class="p-4 text-right">
                            <input type="number" step="${h.currency==='USD'?'0.01':'0.1'}" 
                                value="${h.currentPrice}" 
                                onchange="updatePrice('${h.code}', this.value)"
                                class="w-20 text-right border border-slate-200 rounded px-1 py-1 focus:outline-none focus:border-blue-500 font-mono bg-white hover:border-slate-300 transition-colors"
                            >
                        </td>
                        <td class="p-4 text-right font-medium">${currencySymbol} ${fmtMoney(h.marketValue)}</td>
                        <td class="p-4 text-right font-bold ${pnlColor}">
                            ${h.unrealizedPnL > 0 ? '+' : ''}${fmtMoney(h.unrealizedPnL)}
                        </td>
                        <td class="p-4 text-right">
                            <span class="px-2 py-1 rounded text-xs font-bold ${badgeColor}">
                                ${h.returnRate > 0 ? '+' : ''}${h.returnRate.toFixed(2)}%
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function renderTransactionsTable() {
            const container = document.getElementById('contentArea');
            // Filter first
            const filteredTrans = state.activeAccountId === 'all' 
                ? state.transactions 
                : state.transactions.filter(t => t.accountId === state.activeAccountId);
            
            const trans = [...filteredTrans].reverse();

            if (trans.length === 0) {
                container.innerHTML = `<div class="p-12 text-center text-slate-400">å°šç„¡äº¤æ˜“ç´€éŒ„</div>`;
                return;
            }

            let html = `
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-4">æ—¥æœŸ</th>
                                ${state.activeAccountId === 'all' ? '<th class="p-4">å¸³æˆ¶</th>' : ''}
                                <th class="p-4">é¡åˆ¥</th>
                                <th class="p-4">è‚¡ç¥¨</th>
                                <th class="p-4 text-right">åƒ¹æ ¼</th>
                                <th class="p-4 text-right">è‚¡æ•¸</th>
                                <th class="p-4 text-right">è²»ç”¨</th>
                                <th class="p-4 text-right">ç¸½é‡‘é¡</th>
                                <th class="p-4 text-center">åˆªé™¤</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
            `;

            trans.forEach(t => {
                const isBuy = t.type === 'buy';
                const total = (t.price * t.qty) + (isBuy ? Number(t.fee) : -Number(t.fee));
                const currency = t.currency || 'TWD';
                // æ‰¾å¸³æˆ¶åç¨±
                const accName = state.accounts.find(a => a.id === t.accountId)?.name || 'æœªçŸ¥';
                
                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-4 text-slate-500 text-xs">${t.date}</td>
                         ${state.activeAccountId === 'all' ? `<td class="p-4 text-xs text-slate-500">${accName}</td>` : ''}
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${isBuy ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                ${isBuy ? 'è²·å…¥' : 'è³£å‡º'}
                            </span>
                        </td>
                        <td class="p-4">
                            <div class="text-slate-800 font-medium">${t.name}</div>
                            <div class="text-xs text-slate-400">${t.code}</div>
                        </td>
                        <td class="p-4 text-right font-mono">${t.price}</td>
                        <td class="p-4 text-right font-mono">${t.qty}</td>
                        <td class="p-4 text-right text-slate-400 text-xs">${t.fee}</td>
                        <td class="p-4 text-right font-bold text-slate-700">${currency} ${total.toLocaleString()}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteTransaction(${t.id})" class="text-slate-300 hover:text-red-500 transition-colors p-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- 5. å¸³æˆ¶ç®¡ç†åŠŸèƒ½ ---
        function toggleAccountMenu() {
            const menu = document.getElementById('accountMenu');
            menu.classList.toggle('hidden');
        }

        // æ›´æ–°å¸³æˆ¶é¸å–® UI
        function updateAccountMenuUI() {
            // 1. æ›´æ–° Navbar ä¸‹æ‹‰æ¸…å–®
            const listContainer = document.getElementById('accountListContainer');
            listContainer.innerHTML = '';
            
            // "å…¨éƒ¨å¸³æˆ¶" é¸é …
            const allDiv = document.createElement('div');
            allDiv.className = `px-4 py-3 cursor-pointer hover:bg-slate-50 flex justify-between items-center ${state.activeAccountId === 'all' ? 'bg-blue-50 text-blue-700' : ''}`;
            allDiv.onclick = () => switchAccount('all');
            allDiv.innerHTML = `<span class="font-medium">å…¨éƒ¨å¸³æˆ¶ (ç¸½è¦½)</span> ${state.activeAccountId === 'all' ? '<i class="fa-solid fa-check text-xs"></i>' : ''}`;
            listContainer.appendChild(allDiv);

            // å€‹åˆ¥å¸³æˆ¶é¸é …
            state.accounts.forEach(acc => {
                const div = document.createElement('div');
                div.className = `px-4 py-3 cursor-pointer hover:bg-slate-50 flex justify-between items-center border-t border-slate-50 ${state.activeAccountId === acc.id ? 'bg-blue-50 text-blue-700' : ''}`;
                div.onclick = () => switchAccount(acc.id);
                div.innerHTML = `<span>${acc.name}</span> ${state.activeAccountId === acc.id ? '<i class="fa-solid fa-check text-xs"></i>' : ''}`;
                listContainer.appendChild(div);
            });

            // 2. æ›´æ–° Navbar æŒ‰éˆ•æ–‡å­—
            const currentLabel = document.getElementById('currentAccountLabel');
            if (state.activeAccountId === 'all') {
                currentLabel.innerText = "å…¨éƒ¨å¸³æˆ¶";
            } else {
                const acc = state.accounts.find(a => a.id === state.activeAccountId);
                currentLabel.innerText = acc ? acc.name : 'é¸æ“‡å¸³æˆ¶';
            }

            // 3. æ›´æ–° Modal è£¡çš„é¸å–®
            const modalSelect = document.getElementById('modalAccountSelect');
            modalSelect.innerHTML = '';
            state.accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                opt.text = acc.name;
                modalSelect.appendChild(opt);
            });
            
            // å¦‚æœç•¶å‰æ˜¯åœ¨ç‰¹å®šå¸³æˆ¶ä¸‹ï¼ŒModal é è¨­é¸è©²å¸³æˆ¶
            if (state.activeAccountId !== 'all') {
                modalSelect.value = state.activeAccountId;
            }
        }

        function switchAccount(id) {
            state.activeAccountId = id;
            document.getElementById('accountMenu').classList.add('hidden');
            updateAccountMenuUI();
            renderAll();
        }

        function openAccountManager() {
            document.getElementById('accountMenu').classList.add('hidden');
            document.getElementById('accountManagerModal').classList.remove('hidden');
            document.getElementById('accountManagerModal').classList.add('flex');
            renderAccountManagerList();
        }

        function closeAccountManager() {
            document.getElementById('accountManagerModal').classList.add('hidden');
            document.getElementById('accountManagerModal').classList.remove('flex');
        }

        function renderAccountManagerList() {
            const list = document.getElementById('manageAccountList');
            list.innerHTML = '';
            
            state.accounts.forEach(acc => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-slate-50 p-3 rounded-lg";
                // ä¸å…è¨±åˆªé™¤æœ€å¾Œä¸€å€‹å¸³æˆ¶
                const canDelete = state.accounts.length > 1;
                
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${acc.name}</span>
                    ${canDelete ? `
                        <button onclick="deleteAccount('${acc.id}')" class="text-slate-400 hover:text-red-500 transition-colors text-sm px-2">
                            <i class="fa-solid fa-trash"></i> åˆªé™¤
                        </button>
                    ` : '<span class="text-xs text-slate-300">é è¨­</span>'}
                `;
                list.appendChild(div);
            });
        }

        function addNewAccount() {
            const input = document.getElementById('newAccountName');
            const name = input.value.trim();
            if (!name) return;

            const newId = 'acc_' + Date.now();
            state.accounts.push({ id: newId, name: name });
            saveData();
            
            input.value = '';
            renderAccountManagerList();
            updateAccountMenuUI();
        }

        function deleteAccount(id) {
            if (!confirm("åˆªé™¤å¸³æˆ¶ä¸æœƒåˆªé™¤è£¡é¢çš„äº¤æ˜“ç´€éŒ„ï¼Œä½†ç´€éŒ„æœƒè®Šæˆå­¤å…’ç„¡æ³•é¡¯ç¤º(é™¤éæ­¸æˆ¶åˆ°åˆ¥çš„)ã€‚\n\nç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            
            state.accounts = state.accounts.filter(a => a.id !== id);
            // è‹¥åˆªé™¤çš„æ˜¯ç•¶å‰å¸³æˆ¶ï¼Œåˆ‡å› All
            if (state.activeAccountId === id) {
                state.activeAccountId = 'all';
            }
            // ç°¡å–®è™•ç†ï¼šå°‡è©²å¸³æˆ¶çš„äº¤æ˜“æ­¸åˆ°ç¬¬ä¸€å€‹å¸³æˆ¶ (é¿å…è³‡æ–™éºå¤±)
            const fallbackId = state.accounts[0].id;
            state.transactions.forEach(t => {
                if(t.accountId === id) t.accountId = fallbackId;
            });

            saveData();
            renderAccountManagerList();
            updateAccountMenuUI();
            renderAll();
        }

        // --- 6. å…¶ä»– UI åŠŸèƒ½ ---
        function switchTab(tab) {
            state.activeTab = tab;
            // Update UI styles
            document.getElementById('tab-portfolio').className = tab === 'portfolio' ? 
                'pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-blue-600 text-blue-600' : 
                'pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-700';
            
            document.getElementById('tab-transactions').className = tab === 'transactions' ? 
                'pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-blue-600 text-blue-600' : 
                'pb-3 px-2 text-sm font-medium transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-700';
            
            renderAll();
        }

        function updatePrice(code, newPrice) {
            state.currentPrices[code] = Number(newPrice);
            saveData();
            renderAll();
        }

        function deleteTransaction(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveData();
                renderAll();
            }
        }

        // --- Modal & Form ---
        function openModal() {
            document.getElementById('transactionModal').classList.remove('hidden');
            document.getElementById('transactionModal').classList.add('flex');
            // å¦‚æœç•¶å‰æ˜¯ Allï¼Œé¸å–®é è¨­é¸ç¬¬ä¸€å€‹ï¼Œå¦å‰‡é¸ç•¶å‰
            const select = document.getElementById('modalAccountSelect');
            if (state.activeAccountId !== 'all') {
                select.value = state.activeAccountId;
            }
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            document.getElementById('transactionModal').classList.remove('flex');
            // Reset form suggestion
            document.getElementById('autocomplete-list').innerHTML = '';
            document.getElementById('autocomplete-list').classList.add('hidden');
        }

        function setTransactionType(type) {
            document.getElementById('type').value = type;
            const btnBuy = document.getElementById('btn-buy');
            const btnSell = document.getElementById('btn-sell');
            
            if (type === 'buy') {
                btnBuy.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all bg-red-500 text-white shadow-sm";
                btnSell.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-slate-500 hover:bg-slate-200";
            } else {
                btnBuy.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all text-slate-500 hover:bg-slate-200";
                btnSell.className = "flex-1 py-1.5 text-sm font-medium rounded-md transition-all bg-green-600 text-white shadow-sm";
            }
        }

        // æœå°‹è‡ªå‹•å®ŒæˆåŠŸèƒ½
        function handleStockInput(val) {
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            list.classList.add('hidden');
            
            if (!val) return;

            const matches = STOCK_DB.filter(s => 
                s.code.includes(val.toUpperCase()) || s.name.includes(val)
            );

            if (matches.length > 0) {
                list.classList.remove('hidden');
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${match.code}</span>
                            <span class="text-sm text-slate-500">${match.name}</span>
                        </div>
                        <div class="text-xs text-slate-400 mt-1 flex justify-between">
                            <span>${match.type === 'TW' ? 'ğŸ‡¹ğŸ‡¼ å°è‚¡' : 'ğŸ‡ºğŸ‡¸ ç¾è‚¡'}</span>
                            <span>åƒè€ƒåƒ¹: ${match.price}</span>
                        </div>
                    `;
                    div.onclick = () => selectStock(match);
                    list.appendChild(div);
                });
            }
        }

        function selectStock(stock) {
            document.getElementById('code').value = stock.code;
            document.getElementById('name').value = stock.name;
            document.getElementById('price').value = stock.price;
            document.getElementById('currency').value = stock.type === 'TW' ? 'TWD' : 'USD';
            
            document.getElementById('autocomplete-list').innerHTML = '';
            document.getElementById('autocomplete-list').classList.add('hidden');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const newTrans = {
                id: Date.now(),
                accountId: document.getElementById('modalAccountSelect').value,
                date: document.getElementById('date').value,
                type: document.getElementById('type').value,
                code: document.getElementById('code').value.toUpperCase(),
                name: document.getElementById('name').value || document.getElementById('code').value,
                currency: document.getElementById('currency').value,
                price: Number(document.getElementById('price').value),
                qty: Number(document.getElementById('qty').value),
                fee: Number(document.getElementById('fee').value)
            };

            state.transactions.push(newTrans);
            
            // æ›´æ–°ç¾åƒ¹
            state.currentPrices[newTrans.code] = newTrans.price;
            
            saveData();
            closeModal();
            renderAll();
            
            // æ¸…ç©ºéƒ¨åˆ†æ¬„ä½
            document.getElementById('price').value = '';
            document.getElementById('qty').value = '';
            document.getElementById('fee').value = 0;
            document.getElementById('code').value = '';
            document.getElementById('name').value = '';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('transactionModal')) {
                closeModal();
            }
            if (event.target == document.getElementById('accountManagerModal')) {
                closeAccountManager();
            }
            // Close dropdown if clicked outside
            if (!event.target.closest('.group') && !document.getElementById('accountMenu').classList.contains('hidden')) {
                 document.getElementById('accountMenu').classList.add('hidden');
            }
        }
    </script>
</body>
</html>